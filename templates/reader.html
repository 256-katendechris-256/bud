{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bud | {{ book.title }}</title>
  <link rel="icon" type="image/png" href="{% static 'img/bud.png' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.mjs" type="module"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Manrope", sans-serif;
      background: #1a1a2e;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .reader-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: #16213e;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      flex-shrink: 0;
      z-index: 10;
    }

    .reader-back {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.15);
      background: transparent;
      color: #fff;
      font-size: 1.1rem;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s;
    }
    .reader-back:hover { background: rgba(255,255,255,0.1); }

    .reader-title {
      font-size: 0.95rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .reader-author {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Navigation controls */
    .reader-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .reader-controls button {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.15);
      background: transparent;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .reader-controls button:hover { background: rgba(255,255,255,0.1); }
    .reader-controls button:disabled { opacity: 0.3; cursor: default; }
    .reader-page-info {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.6);
      min-width: 70px;
      text-align: center;
    }

    /* Bookmark button — overrides the generic 32px square rule */
    .btn-bookmark {
      width: auto !important;
      height: 34px !important;
      padding: 0 14px !important;
      gap: 6px !important;
      background: #6c63ff !important;
      border-color: #6c63ff !important;
      border-radius: 8px !important;
      font-size: 0.78rem !important;
      font-weight: 700 !important;
      letter-spacing: 0.01em;
      white-space: nowrap;
      transition: background 0.2s, opacity 0.2s !important;
    }
    .btn-bookmark:hover { background: #5a52d5 !important; }
    .btn-bookmark:disabled { opacity: 0.45 !important; cursor: default; }

    /* Notes button — same pill style as bookmark */
    .btn-notes {
      width: auto !important;
      height: 34px !important;
      padding: 0 14px !important;
      gap: 6px !important;
      background: rgba(255,255,255,0.08) !important;
      border: 1px solid rgba(255,255,255,0.2) !important;
      border-radius: 8px !important;
      font-size: 0.78rem !important;
      font-weight: 700 !important;
      white-space: nowrap;
      transition: background 0.2s !important;
    }
    .btn-notes:hover { background: rgba(255,255,255,0.15) !important; }
    .btn-notes.is-open { background: rgba(255,255,255,0.18) !important; border-color: rgba(255,255,255,0.4) !important; }

    /* Notes panel */
    .notes-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #16213e;
      border-top: 1px solid rgba(255,255,255,0.12);
      border-radius: 20px 20px 0 0;
      max-height: 62vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 150;
    }
    .notes-panel.is-open { transform: translateY(0); }

    .notes-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      flex-shrink: 0;
    }
    .notes-panel-header h3 {
      font-size: 0.95rem;
      font-weight: 700;
    }
    .notes-panel-close {
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 1rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .notes-panel-close:hover { color: #fff; background: rgba(255,255,255,0.1); }

    .notes-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px 20px;
    }
    .note-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .note-item:last-child { border-bottom: none; }
    .note-page {
      flex-shrink: 0;
      font-size: 0.72rem;
      font-weight: 700;
      background: rgba(108,99,255,0.3);
      color: #a89cff;
      padding: 3px 8px;
      border-radius: 10px;
      white-space: nowrap;
      margin-top: 1px;
    }
    .note-text {
      flex: 1;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.85);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .note-delete {
      background: none;
      border: none;
      color: rgba(255,255,255,0.25);
      font-size: 0.8rem;
      cursor: pointer;
      padding: 2px 4px;
      flex-shrink: 0;
      transition: color 0.15s;
    }
    .note-delete:hover { color: #f87171; }
    .notes-empty {
      text-align: center;
      color: rgba(255,255,255,0.35);
      font-size: 0.85rem;
      padding: 24px 0;
    }

    .notes-compose {
      flex-shrink: 0;
      padding: 12px 20px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .notes-compose-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .notes-textarea {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      color: #fff;
      font-family: "Manrope", sans-serif;
      font-size: 0.88rem;
      padding: 10px 12px;
      resize: none;
      height: 64px;
      outline: none;
    }
    .notes-textarea::placeholder { color: rgba(255,255,255,0.3); }
    .notes-textarea:focus { border-color: rgba(108,99,255,0.7); }
    .notes-add-btn {
      flex-shrink: 0;
      height: 36px;
      padding: 0 16px;
      border-radius: 8px;
      border: none;
      background: #6c63ff;
      color: #fff;
      font-family: "Manrope", sans-serif;
      font-size: 0.82rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .notes-add-btn:hover { opacity: 0.85; }
    .notes-page-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.4);
    }

    /* PDF canvas area */
    .reader-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      gap: 12px;
    }

    .reader-body canvas {
      max-width: 100%;
      box-shadow: 0 2px 20px rgba(0,0,0,0.4);
    }

    /* Loading state */
    .reader-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      color: rgba(255,255,255,0.6);
    }
    .reader-loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #6c63ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Error state */
    .reader-error {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      padding: 24px;
      text-align: center;
      color: rgba(255,255,255,0.6);
    }
    .reader-error a {
      display: inline-block;
      padding: 12px 28px;
      background: #6c63ff;
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .reader-error a:hover { opacity: 0.9; }

    @media (max-width: 480px) {
      .reader-header { padding: 10px 14px; gap: 8px; }
      .reader-author { display: none; }
      .reader-body { padding: 10px 0; }
    }

    /* Auto-save toast */
    .reader-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(108, 99, 255, 0.92);
      color: #fff;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 200;
      white-space: nowrap;
    }
    .reader-toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="reader-header">
    <a class="reader-back" href="/books/" title="Back to Books">&#8592;</a>
    <span class="reader-title">{{ book.title }}</span>
    <span class="reader-author">{{ book.author }}</span>
    <div class="reader-controls">
      <button id="prev-btn" title="Previous page" disabled>&#9664;</button>
      <span class="reader-page-info" id="page-info">...</span>
      <button id="next-btn" title="Next page" disabled>&#9654;</button>
      <button id="bookmark-btn" class="btn-bookmark" title="Set bookmark — saves your progress" disabled>
        &#128278; Bookmark
      </button>
      <button id="notes-btn" class="btn-notes" title="Reading notes" disabled>
        &#128221; Notes
      </button>
    </div>
  </div>

  <!-- Notes panel -->
  <div class="notes-panel" id="notes-panel">
    <div class="notes-panel-header">
      <h3>&#128221; Notes — {{ book.title|truncatechars:30 }}</h3>
      <button class="notes-panel-close" id="notes-close" type="button">&#10005;</button>
    </div>
    <div class="notes-list" id="notes-list">
      <div class="notes-empty">No notes yet.</div>
    </div>
    <div class="notes-compose">
      <div class="notes-page-label" id="notes-page-label">Note for page 1</div>
      <div class="notes-compose-row">
        <textarea class="notes-textarea" id="notes-textarea" placeholder="Type your note here..."></textarea>
        <button class="notes-add-btn" id="notes-add-btn" type="button">Add</button>
      </div>
    </div>
  </div>

  <div class="reader-body" id="reader-body">
    <div class="reader-loading" id="reader-loading">
      <div class="spinner"></div>
      <span>Loading PDF...</span>
    </div>
  </div>

  <div class="reader-toast" id="reader-toast">Progress saved</div>

  <div class="reader-error" id="reader-error">
    <p>Could not load the PDF in the browser.</p>
    <a href="{{ book.file.url }}" target="_blank" rel="noopener">Download PDF instead</a>
  </div>

  <script type="module">
    const PDF_URL      = "{{ book.file.url }}";
    const WORKER_URL   = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.mjs";
    const BOOK_ID      = {{ book.id }};
    const INITIAL_PAGE = {{ start_page|default:0 }};

    const container   = document.getElementById("reader-body");
    const loading     = document.getElementById("reader-loading");
    const errorEl     = document.getElementById("reader-error");
    const prevBtn     = document.getElementById("prev-btn");
    const nextBtn     = document.getElementById("next-btn");
    const pageInfo    = document.getElementById("page-info");
    const toast       = document.getElementById("reader-toast");
    const bookmarkBtn = document.getElementById("bookmark-btn");
    const notesBtn    = document.getElementById("notes-btn");
    const notesPanel  = document.getElementById("notes-panel");
    const notesClose  = document.getElementById("notes-close");
    const notesList   = document.getElementById("notes-list");
    const notesInput  = document.getElementById("notes-textarea");
    const notesAddBtn = document.getElementById("notes-add-btn");
    const notesPageLabel = document.getElementById("notes-page-label");

    let pdfDoc      = null;
    let currentPage = 1;
    let rendering   = false;

    // Bookmark / session tracking
    // trackStartPage = the page the user was on when they last bookmarked (or opened)
    // sessionStart   = the time they opened the reader (or last bookmarked)
    let trackStartPage = 0;
    let sessionStart   = Date.now();

    // JWT token is stored in localStorage by the main app JS
    function getAuthToken() {
      return localStorage.getItem("bud_access") || "";
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    // Called when the user taps the Bookmark button.
    // Logs a reading session from the last bookmark page to the current page,
    // with duration = time since the reader was opened / last bookmarked.
    async function saveBookmark() {
      const endPage = currentPage;

      if (endPage === trackStartPage) {
        showToast("Turn some pages first!");
        return;
      }

      const token = getAuthToken();
      if (!token) {
        showToast("Not logged in — please log in again");
        return;
      }

      const minutes = Math.max(1, Math.round((Date.now() - sessionStart) / 60000));

      bookmarkBtn.disabled = true;
      bookmarkBtn.innerHTML = "Saving...";

      try {
        const resp = await fetch("/api/reading/progress/log-session/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
          body: JSON.stringify({
            book_id: BOOK_ID,
            start_page: trackStartPage,
            end_page: endPage,
            duration_minutes: minutes,
          }),
        });

        if (resp.ok) {
          const session = await resp.json();
          trackStartPage = endPage;
          sessionStart   = Date.now();
          showToast(`\uD83D\uDD16 Bookmarked \u00B7 +${session.xp_earned} XP`);
        } else {
          const err = await resp.json().catch(() => ({}));
          showToast(err.detail || "Could not save — try again");
        }
      } catch (_) {
        showToast("Could not save — check your connection");
      } finally {
        bookmarkBtn.disabled = false;
        bookmarkBtn.innerHTML = "\uD83D\uDD16 Bookmark";
      }
    }

    bookmarkBtn.addEventListener("click", saveBookmark);

    // --------------------------------------------------------
    // NOTES — stored in localStorage, keyed by book id
    // --------------------------------------------------------
    const NOTES_KEY = `bud_notes_${BOOK_ID}`;

    function getNotes() {
      try { return JSON.parse(localStorage.getItem(NOTES_KEY) || "[]"); }
      catch (_) { return []; }
    }

    function saveNotes(notes) {
      localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    }

    function noteEscape(str) {
      const d = document.createElement("div");
      d.textContent = str || "";
      return d.innerHTML;
    }

    function renderNotes() {
      const notes = getNotes();
      if (!notes.length) {
        notesList.innerHTML = '<div class="notes-empty">No notes yet. Add one below.</div>';
        return;
      }
      notesList.innerHTML = notes.map((n, i) => `
        <div class="note-item">
          <span class="note-page">p.${n.page}</span>
          <span class="note-text">${noteEscape(n.text)}</span>
          <button class="note-delete" data-idx="${i}" title="Delete note">&#10005;</button>
        </div>
      `).join("");

      notesList.querySelectorAll(".note-delete").forEach((btn) => {
        btn.addEventListener("click", () => {
          const notes = getNotes();
          notes.splice(parseInt(btn.dataset.idx), 1);
          saveNotes(notes);
          renderNotes();
        });
      });
    }

    notesBtn.addEventListener("click", () => {
      const open = notesPanel.classList.toggle("is-open");
      notesBtn.classList.toggle("is-open", open);
      if (open) {
        renderNotes();
        notesInput.focus();
      }
    });

    notesClose.addEventListener("click", () => {
      notesPanel.classList.remove("is-open");
      notesBtn.classList.remove("is-open");
    });

    notesAddBtn.addEventListener("click", () => {
      const text = notesInput.value.trim();
      if (!text) return;
      const notes = getNotes();
      notes.push({ page: currentPage, text, time: Date.now() });
      saveNotes(notes);
      notesInput.value = "";
      renderNotes();
      showToast("Note added");
    });

    // Allow Ctrl+Enter to save note
    notesInput.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") notesAddBtn.click();
    });

    // --- PDF rendering ---
    async function init() {
      try {
        const pdfjsLib = await import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.mjs");
        pdfjsLib.GlobalWorkerOptions.workerSrc = WORKER_URL;

        pdfDoc = await pdfjsLib.getDocument(PDF_URL).promise;
        loading.style.display = "none";

        // Jump to where the user left off
        const resumePage = Math.max(1, Math.min(INITIAL_PAGE || 1, pdfDoc.numPages));
        currentPage    = resumePage;
        trackStartPage = resumePage;  // bookmark session starts here
        sessionStart   = Date.now();  // timer starts now

        prevBtn.disabled = false;
        nextBtn.disabled = false;
        bookmarkBtn.disabled = false;
        notesBtn.disabled = false;
        notesPageLabel.textContent = `Note for page ${currentPage}`;

        updatePageInfo();
        renderPage(currentPage);

        if (INITIAL_PAGE > 1) {
          showToast(`Resumed at page ${INITIAL_PAGE}`);
        }
      } catch (err) {
        console.error("PDF load error:", err);
        loading.style.display = "none";
        container.style.display = "none";
        errorEl.style.display = "flex";
      }
    }

    function updatePageInfo() {
      pageInfo.textContent = `${currentPage} / ${pdfDoc.numPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= pdfDoc.numPages;
    }

    async function renderPage(num) {
      if (rendering) return;
      rendering = true;

      const page = await pdfDoc.getPage(num);

      const containerWidth = container.clientWidth - 40;
      const unscaledViewport = page.getViewport({ scale: 1 });
      const scale = Math.min(containerWidth / unscaledViewport.width, 2.0);
      const viewport = page.getViewport({ scale });

      let canvas = document.getElementById("pdf-canvas");
      if (!canvas) {
        canvas = document.createElement("canvas");
        canvas.id = "pdf-canvas";
        container.appendChild(canvas);
      }
      const ctx = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width  = viewport.width;

      await page.render({ canvasContext: ctx, viewport }).promise;
      rendering = false;
    }

    function onPageChange() {
      updatePageInfo();
      notesPageLabel.textContent = `Note for page ${currentPage}`;
    }

    prevBtn.addEventListener("click", () => {
      if (currentPage <= 1) return;
      currentPage--;
      onPageChange();
      renderPage(currentPage);
      container.scrollTop = 0;
    });

    nextBtn.addEventListener("click", () => {
      if (currentPage >= pdfDoc.numPages) return;
      currentPage++;
      onPageChange();
      renderPage(currentPage);
      container.scrollTop = 0;
    });

    document.addEventListener("keydown", (e) => {
      // Don't hijack keys when user is typing in the notes textarea
      if (e.target === notesInput) return;
      if (e.key === "ArrowLeft"  || e.key === "ArrowUp")   prevBtn.click();
      if (e.key === "ArrowRight" || e.key === "ArrowDown")  nextBtn.click();
      if (e.key === "b" || e.key === "B")                   bookmarkBtn.click();
      if (e.key === "n" || e.key === "N")                   notesBtn.click();
    });

    init();
  </script>
</body>
</html>
